{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { min-height: 100vh; display: flex; font-family: 'Segoe UI', sans-serif; background-color: #f0f4f8; }

        /* Sidebar */
        .sidebar { width: 220px; background-color: #1e3a8a; color: white; flex-shrink: 0; }
        .sidebar h3 { text-align: center; padding: 20px 0; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .sidebar a { color: #fff; text-decoration: none; display: block; padding: 12px 20px; transition: 0.2s; }
        .sidebar a.active, .sidebar a:hover { background-color: #2563eb; }

        /* Navbar */
        .navbar { position: fixed; width: calc(100% - 220px); left: 220px; z-index: 1000; }

        /* Content */
        .content { flex-grow: 1; padding: 80px 30px 30px 30px; }

        /* Cards */
        .card { border-radius: 12px; }
        .card h3 { margin: 0; font-weight: bold; text-align: center; }

        /* Tables */
        .table thead { background-color: #1e40af; color: white; }
        .table-striped tbody tr:nth-of-type(odd) { background-color: rgba(30, 58, 138, 0.1); }
        .table td, .table th { vertical-align: middle; }

        canvas { background-color: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }

        @media(max-width: 768px) {
            .navbar { width: 100%; left: 0; }
            .sidebar { position: fixed; z-index: 999; height: 100%; transform: translateX(-100%); transition: transform 0.3s; }
            .sidebar.show { transform: translateX(0); }
        }
    </style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar d-flex flex-column">
    <h3>Admin</h3>
    <a href="{% url 'admin_dashboard' %}" class="{% if not section %}active{% endif %}">Dashboard</a>
    <a href="{% url 'admin_dashboard_section' 'users' %}" class="{% if section == 'users' %}active{% endif %}">Users</a>
    <a href="{% url 'admin_dashboard_section' 'jobs' %}" class="{% if section == 'jobs' %}active{% endif %}">Jobs</a>
    <a href="{% url 'admin_dashboard_section' 'applications' %}" class="{% if section == 'applications' %}active{% endif %}">Applications</a>
    <a href="{% url 'admin_dashboard_section' 'resumes' %}" class="{% if section == 'resumes' %}active{% endif %}">Resumes</a>
    <a href="{% url 'admin_dashboard_section' 'training' %}" class="{% if section == 'training' %}active{% endif %}">Training</a>
    <a href="{% url 'admin_dashboard_section' 'subscriptions' %}" class="{% if section == 'subscriptions' %}active{% endif %}">Subscriptions</a>
    <a href="{% url 'admin_dashboard_section' 'mock_interviews' %}" class="{% if section == 'mock_interviews' %}active{% endif %}">Mock Interviews</a>
</div>

<!-- Top Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
        <a class="navbar-brand" href="{% url 'admin_dashboard' %}">Admin Panel</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarTop">
            <span class="navbar-toggler-icon"></span>
        </button>
        <form method="post" action="{% url 'logout' %}" class="ms-auto">
            {% csrf_token %}
            <button class="btn btn-warning btn-sm">Logout</button>
        </form>
    </div>
</nav>

<!-- Content -->
<div class="content">

    {% if not section %}
    <h2 class="mb-4">Dashboard Overview</h2>
    <div class="row g-3">
        <div class="col-md-3"><div class="card text-white bg-primary"><div class="card-body"><h5><i class="bi bi-people"></i> Users</h5><h3>{{ total_users }}</h3></div></div></div>
        <div class="col-md-3"><div class="card text-white bg-info"><div class="card-body"><h5><i class="bi bi-briefcase"></i> Jobs</h5><h3>{{ total_jobs }}</h3></div></div></div>
        <div class="col-md-3"><div class="card text-white bg-warning"><div class="card-body"><h5><i class="bi bi-journal-text"></i> Applications</h5><h3>{{ total_applications }}</h3></div></div></div>
        <div class="col-md-3"><div class="card text-white bg-success"><div class="card-body"><h5><i class="bi bi-cash-stack"></i> Revenue</h5><h3>${{ total_revenue }}</h3></div></div></div>
    </div>

    <div class="row mt-5">
        <div class="col-md-6 mb-3"><canvas id="usersChart"></canvas></div>
        <div class="col-md-6 mb-3"><canvas id="revenueChart"></canvas></div>
    </div>
    {% endif %}

    {% if section %}
        <h3 class="mb-3">{{ section|capfirst }}</h3>
        <div class="table-responsive">
            <table class="table table-striped table-bordered align-middle">
                <thead>
                    <tr>
                        {% if section == 'users' %}<th>Username</th><th>Email</th><th>User Type</th><th>Subscription</th><th>Joined At</th>{% endif %}
                        {% if section == 'jobs' %}<th>Title</th><th>Company</th><th>Location</th><th>Posted By</th><th>Created At</th>{% endif %}
                        {% if section == 'applications' %}<th>Job</th><th>User</th><th>Email</th><th>Phone</th><th>Applied At</th>{% endif %}
                        {% if section == 'resumes' %}<th>User</th><th>Template</th><th>Created At</th>{% endif %}
                        {% if section == 'training' %}<th>Course</th><th>Duration (Days)</th><th>Price</th><th>Active</th>{% endif %}
                        {% if section == 'subscriptions' %}<th>User</th><th>Plan</th><th>Amount Paid</th><th>Status</th><th>Created At</th>{% endif %}
                        {% if section == 'mock_interviews' %}
                            <th>Consultant</th>
                            <th>Date & Time</th>
                            <th>User</th>
                            <th>Interview Type</th>
                            <th>Target Role</th>
                            <th>Scheduled At</th>
                            <th>Status</th>
                            <th>Feedback</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for item in section_data.items %}
                        <tr>
                            {% if section == 'users' %}
                                <td>{{ item.username }}</td><td>{{ item.email }}</td><td>{{ item.user_type }}</td><td>{{ item.subscription.plan }}</td><td>{{ item.date_joined|date:"d M Y" }}</td>
                            {% elif section == 'jobs' %}
                                <td>{{ item.title }}</td><td>{{ item.company }}</td><td>{{ item.location }}</td><td>{{ item.posted_by.username }}</td><td>{{ item.created_at|date:"d M Y" }}</td>
                            {% elif section == 'applications' %}
                                <td>{{ item.job.title }}</td><td>{{ item.user.username }}</td><td>{{ item.email }}</td><td>{{ item.phone }}</td><td>{{ item.applied_at|date:"d M Y" }}</td>
                            {% elif section == 'resumes' %}
                                <td>{{ item.user.username }}</td><td>{{ item.template.name }}</td><td>{{ item.created_at|date:"d M Y" }}</td>
                            {% elif section == 'training' %}
                                <td>{{ item.title }}</td><td>{{ item.duration_days }}</td><td>{{ item.price }}</td><td>{{ item.is_active }}</td>
                            {% elif section == 'subscriptions' %}
                                <td>{{ item.user.username }}</td><td>{{ item.plan }}</td><td>{{ item.amount_paid }}</td><td>{{ item.payment_status }}</td><td>{{ item.created_at|date:"d M Y" }}</td>
                            {% elif section == 'mock_interviews' %}
                                <td>{{ item.slot.consultant_name }}</td>
                                <td>{{ item.slot.date|date:"d M Y" }} {{ item.slot.time|time:"H:i" }}</td>
                                <td>{% if item.user %}{{ item.user.username }}{% else %}<span class="text-success">Available</span>{% endif %}</td>
                                <td>{{ item.interview_type|default:"-" }}</td>
                                <td>{{ item.target_role|default:"-" }}</td>
                                <td>{% if item.scheduled_at %}{{ item.scheduled_at|date:"d M Y H:i" }}{% else %}-{% endif %}</td>
                                <td>
                                    {% if item.user %}
                                        {% if item.completed %}
                                            <span class="badge bg-success">Completed</span>
                                        {% elif item.canceled %}
                                            <span class="badge bg-danger">Canceled</span>
                                        {% else %}
                                            <span class="badge bg-warning">Pending</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-info">Available</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.feedback_report %}
                                        <a href="{{ item.feedback_report.url }}" class="btn btn-sm btn-primary" target="_blank">View</a>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            {% endif %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}

</div>

<script>
const usersCtx = document.getElementById('usersChart')?.getContext('2d');
if(usersCtx){
    new Chart(usersCtx, {
        type: 'line',
        data: {
            labels: {{ months|safe }},
            datasets: [{ label: 'New Users', data: {{ user_counts|safe }}, backgroundColor: 'rgba(59,130,246,0.2)', borderColor: 'rgba(59,130,246,1)', fill: true, tension: 0.3 }]
        }
    });
}

const revenueCtx = document.getElementById('revenueChart')?.getContext('2d');
if(revenueCtx){
    new Chart(revenueCtx, {
        type: 'bar',
        data: {
            labels: {{ revenue_months|safe }},
            datasets: [{ label: 'Revenue', data: {{ revenue_values|safe }}, backgroundColor: 'rgba(37,99,235,0.6)', borderColor: 'rgba(37,99,235,1)', borderWidth: 1 }]
        }
    });
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
