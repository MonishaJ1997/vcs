{% extends 'base.html' %}
{% block content %}
<div class="container mt-5 pt-5" style="min-height: 80vh;">
    <div class="row justify-content-center">
        <div class="col-md-8">

            <!-- Chatbot Card -->
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-header bg-primary text-white text-center rounded-top-4">
                    <h3 class="fw-bold mb-0">AI Career Chatbot</h3>
                </div>
                <div class="card-body">

                    <!-- Chat Box -->
                    <div id="chat-box" class="border rounded p-3 mb-3" 
                         style="height:350px; overflow-y:auto; background:#f9f9f9;">
                        <!-- Messages will appear here -->
                    </div>

                    <!-- Resume Upload (Pro only) -->
                    <div class="input-group mb-3">
                        <input type="file" id="resume-upload" class="form-control" accept=".pdf,.docx"/>
                        <button class="btn btn-primary" id="upload-resume">Upload Resume</button>
                    </div>

                    <!-- Chat Input -->
                    <div class="input-group mb-2">
                        <input type="text" id="chat-input" class="form-control" placeholder="Type your question..." />
                        <button class="btn btn-success" id="chat-send">Send</button>
                    </div>

                    <!-- Error Message -->
                    <div id="chat-error" class="text-danger mt-2"></div>

                </div>
            </div>

        </div>
    </div>
</div>

<!-- ================== JS ================== -->
<script>
document.addEventListener('DOMContentLoaded', () => {

    const sendBtn = document.getElementById('chat-send');
    const chatInput = document.getElementById('chat-input');
    const chatBox = document.getElementById('chat-box');
    const chatError = document.getElementById('chat-error');
    const uploadBtn = document.getElementById('upload-resume');
    const resumeInput = document.getElementById('resume-upload');

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Send Chat Message
    sendBtn.addEventListener('click', async () => {
        const question = chatInput.value.trim();
        if (!question) return;

        const userMsg = document.createElement('div');
        userMsg.className = 'text-end mb-2';
        userMsg.innerHTML = `<strong>You:</strong> ${question}`;
        chatBox.appendChild(userMsg);
        chatBox.scrollTop = chatBox.scrollHeight;

        chatInput.value = '';
        chatError.textContent = '';

        try {
            const response = await fetch("{% url 'chatbot-ask' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ question })
            });
            const data = await response.json();

            const botMsg = document.createElement('div');
            botMsg.className = 'text-start mb-2';
            botMsg.innerHTML = `<strong>Chatbot:</strong> ${data.answer}`;
            chatBox.appendChild(botMsg);
            chatBox.scrollTop = chatBox.scrollHeight;

        } catch (err) {
            chatError.textContent = "Failed to send question. Please try again.";
            console.error(err);
        }
    });

    // Resume Upload
    uploadBtn.addEventListener('click', async () => {
        const file = resumeInput.files[0];
        if (!file) { alert("Please select a file."); return; }

        const formData = new FormData();
        formData.append('resume', file);

        try {
            const response = await fetch("{% url 'chatbot-upload-resume' %}", {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken },
                body: formData
            });
            const data = await response.json();

            const botMsg = document.createElement('div');
            botMsg.className = 'text-start mb-2';
            botMsg.innerHTML = `<strong>Chatbot [${data.user_type}]:</strong> ${data.message}`;
            chatBox.appendChild(botMsg);
            chatBox.scrollTop = chatBox.scrollHeight;

        } catch (err) {
            console.error(err);
            alert("Error uploading resume. Try again.");
        }
    });

});
</script>

<!-- ================== Styles ================== -->
<style>
#chat-box div {
    padding: 10px 15px;
    border-radius: 8px;
    max-width: 85%;
}

#chat-box .text-end {
    background-color: #d1e7dd; /* User messages */
    margin-left: auto;
}

#chat-box .text-start {
    background-color: #f8d7da; /* Bot messages */
    margin-right: auto;
}

.card-header {
    font-size: 1.25rem;
}

@media(max-width:768px){
    #chat-box { height: 300px; }
}
</style>
{% endblock %}
