{% extends 'base.html' %}
{% block content %}

<div class="checkout-wrapper">

  <div class="checkout-container">

    <!-- LEFT : PLAN SUMMARY -->
    <div class="checkout-summary">

      <h2>Plan Summary</h2>

      <div class="plan-box">
        <h3>{{ plan.title }}</h3>
        <p class="plan-desc">{{ plan.description }}</p>

        <ul class="features">
          {% for feature in plan.features.all %}
          <li>âœ” {{ feature.text }}</li>
          {% endfor %}
        </ul>

        <div class="price-section">
          <span>Total</span>
          <strong>â‚¹ {{ plan.price }}</strong>
        </div>

        <div class="security-note">
          ðŸ”’ Secure checkout â€¢ SSL Protected â€¢ PCI Compliant
        </div>
      </div>

    </div>

    <!-- RIGHT : PAYMENT -->
    <div class="checkout-payment">

      <h2>Payment Details</h2>

      <form id="payment-form" method="POST">
        {% csrf_token %}

        <label>Full Name</label>
        <input id="cardholder-name" type="text" required>

        

        <label>Country</label>
        <select>
          <option>India</option>
          <option>United States</option>
          <option>United Kingdom</option>
          <option>Canada</option>
        </select>

        <label>Card Information</label>
        <div id="card-element" class="card-box"></div>

        <div id="card-errors" class="error"></div>

        <button class="pay-btn">
          Pay â‚¹ {{ plan.price }}
        </button>

        <div class="trust-row">
          <span>ðŸ”’ Secure Payment</span>
          <span>ðŸ’³ Stripe Protected</span>
        </div>

      </form>

    </div>

  </div>

</div>


<!-- STRIPE -->
<script src="https://js.stripe.com/v3/"></script>

<script>
var stripe = Stripe("{{ stripe_publishable_key }}");
var elements = stripe.elements();

var card = elements.create("card");
card.mount("#card-element");

card.on('change', function(event){
    document.getElementById('card-errors').textContent =
        event.error ? event.error.message : '';
});

document.getElementById('payment-form').addEventListener('submit', async function(e){
    e.preventDefault();

    var name = document.getElementById('cardholder-name').value;

    const {paymentIntent, error} =
    await stripe.confirmCardPayment("{{ client_secret }}", {
        payment_method:{
            card:card,
            billing_details:{ name:name }
        }
    });

    if(error){
        document.getElementById('card-errors').textContent = error.message;
        return;
    }

    if(paymentIntent.status === "succeeded"){

        // ðŸ”¥ SEND SUCCESS TO DJANGO VIEW
        fetch(window.location.href,{
            method:"POST",
            headers:{
                "Content-Type":"application/json",
                "X-CSRFToken":"{{ csrf_token }}"
            },
            body:JSON.stringify({
                payment_intent_id:paymentIntent.id
            })
        })
        .then(res=>res.json())
        .then(data=>{
            if(data.status==="success"){
                window.location.href="{% url 'payment_success' plan.plan_type %}";
            }
        });
    }
});
</script>



<style>
/* PAGE WRAPPER */
.checkout-wrapper{
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:flex-start;   /* prevents navbar overlap */
  background:#f4f7fb;
  padding:120px 20px 60px;  /* top spacing for fixed navbar */
}

/* MAIN CONTAINER */
.checkout-container{
  width:100%;
  max-width:1100px;
  display:grid;
  grid-template-columns:1fr 1fr;
  background:white;
  border-radius:20px;
  box-shadow:0 25px 60px rgba(0,0,0,0.08);
  overflow:hidden;
}

/* LEFT PANEL */
.checkout-summary{
  background:linear-gradient(135deg,#1d4ed8,#2563eb);
  color:white;
  padding:45px;
}

.checkout-summary h2{
  font-size:26px;
  font-weight:600;
}

.plan-box{
  margin-top:25px;
}

.plan-box h3{
  font-size:22px;
  margin-bottom:8px;
}

.plan-desc{
  opacity:0.9;
  margin-bottom:20px;
  line-height:1.5;
}

.features{
  list-style:none;
  padding:0;
}

.features li{
  margin-bottom:12px;
  font-size:15px;
}

.price-section{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:24px;
  font-weight:bold;
  margin-top:30px;
  padding-top:20px;
  border-top:1px solid rgba(255,255,255,0.25);
}

.security-note{
  margin-top:20px;
  font-size:13px;
  opacity:0.85;
}

/* RIGHT PANEL */
.checkout-payment{
  padding:45px;
}

.checkout-payment h2{
  font-size:24px;
  margin-bottom:20px;
}

.checkout-payment label{
  display:block;
  margin-top:18px;
  font-size:14px;
  font-weight:500;
}

.checkout-payment input,
.checkout-payment select{
  width:100%;
  padding:13px;
  border-radius:10px;
  border:1px solid #e2e8f0;
  margin-top:6px;
  font-size:14px;
  transition:0.2s;
}

.checkout-payment input:focus,
.checkout-payment select:focus{
  outline:none;
  border-color:#2563eb;
  box-shadow:0 0 0 3px rgba(37,99,235,0.1);
}

/* STRIPE BOX */
.card-box{
  padding:15px;
  border:1px solid #e2e8f0;
  border-radius:10px;
  margin-top:6px;
  background:#fafafa;
}

.error{
  color:#dc2626;
  margin-top:10px;
  font-size:14px;
}

/* PAY BUTTON */
.pay-btn{
  width:100%;
  margin-top:30px;
  padding:15px;
  border:none;
  background:#16a34a;
  color:white;
  border-radius:40px;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
  transition:0.25s;
}

.pay-btn:hover{
  background:#15803d;
  transform:translateY(-1px);
}

/* TRUST ROW */
.trust-row{
  margin-top:18px;
  display:flex;
  justify-content:space-between;
  font-size:13px;
  color:#64748b;
}

/* MOBILE */
@media(max-width:768px){

  .checkout-wrapper{
    padding:100px 15px 40px;
  }

  .checkout-container{
    grid-template-columns:1fr;
  }

  .checkout-summary{
    padding:30px;
  }

  .checkout-payment{
    padding:30px;
  }
}


</style>

{% endblock %}
